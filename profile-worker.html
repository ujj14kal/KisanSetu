<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Worker Profile | Kisan Setu</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <link rel="stylesheet" href="Home.css">
  <link rel="stylesheet" href="auth.css">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
  <div class="container">
    <a class="navbar-brand fw-bold text-success" href="index.html">üåæ Kisan Setu</a>
    <button class="btn btn-outline-success" onclick="logout()">Logout</button>
  </div>
</nav>

<section class="auth-section auth-bg">
  <div class="container">
    <div class="auth-card">

      <h3 class="fw-bold text-center mb-2" id="workerName">Loading...</h3>
      <p class="text-muted text-center mb-3" id="workerLocation"></p>

      <div class="row text-center mb-4">
        <div class="col-6">
          <p class="fw-semibold mb-1">Aadhaar Status</p>
          <span id="aadhaarStatus" class="badge bg-warning">Pending</span>
        </div>
        <div class="col-6">
          <p class="fw-semibold mb-1">Availability</p>
          <span id="availability" class="badge bg-secondary">‚Äî</span>
        </div>
      </div>

      <hr>

      <div class="mb-3">
        <p class="fw-semibold mb-1">Primary Skill</p>
        <p class="text-muted" id="skill">‚Äî</p>
      </div>

      <div class="mb-3">
        <p class="fw-semibold mb-1">Crops Experienced With</p>
        <p class="text-muted" id="crops">‚Äî</p>
      </div>

      <hr>

      <!-- SUBSCRIPTION -->
      <div class="text-center">
        <p class="fw-semibold mb-1">Subscription Status</p>
        <span id="subscriptionBadge" class="badge bg-warning">Inactive</span>

        <div id="subscriptionBtnWrapper" class="mt-2 d-none">
          <button class="btn btn-success w-100" onclick="handlePayment()">
            Activate Subscription ‚Äì ‚Çπ20
          </button>
        </div>

        <div id="searchFarmersWrapper" class="mt-3 d-none">
          <a href="search-farmers.html" class="btn btn-outline-success w-100">
            Search Farmers
          </a>
        </div>
      </div>

      <hr>

      <!-- REQUESTS SENT -->
      <h5 class="fw-bold text-success mt-4">Requests Sent</h5>
      <div id="sentRequests">
        <p class="text-muted small text-center">Loading...</p>
      </div>

    </div>
  </div>
</section>

<script>
  const { createClient } = supabase;

  const supabaseClient = createClient(
    "https://kyujketzdhkbykybjywu.supabase.co",
    "sb_publishable_L4o-HFt5rMGfY5x_UKPVZw_xNVMf59b"
  );

  let currentUser = null;

  async function loadProfile() {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session?.user) {
      location.href = "login-worker.html";
      return;
    }

    currentUser = session.user;

    const { data: profile, error } = await supabaseClient
      .from("profiles")
      .select(`
        full_name,
        role,
        location,
        skill,
        crops,
        availability,
        aadhar_verified,
        subscription_active
      `)
      .eq("id", currentUser.id)
      .single();

    if (error || !profile) {
      location.href = "login-worker.html";
      return;
    }

    // üîê Worker-only guard
    if (profile.role !== "worker") {
      location.href = "profile-farmer.html";
      return;
    }

    document.getElementById("workerName").innerText = profile.full_name;
    document.getElementById("workerLocation").innerText = profile.location || "";
    document.getElementById("skill").innerText = profile.skill || "‚Äî";
    document.getElementById("crops").innerText = profile.crops || "‚Äî";
    document.getElementById("availability").innerText = profile.availability || "‚Äî";

    const aadhaar = document.getElementById("aadhaarStatus");
    aadhaar.innerText = profile.aadhar_verified ? "Verified" : "Pending";
    aadhaar.className = profile.aadhar_verified
      ? "badge bg-success"
      : "badge bg-warning";

    // Subscription UI
    const badge = document.getElementById("subscriptionBadge");
    const payBtn = document.getElementById("subscriptionBtnWrapper");
    const searchBtn = document.getElementById("searchFarmersWrapper");

    if (profile.subscription_active) {
      badge.innerText = "Active";
      badge.className = "badge bg-success";
      payBtn.classList.add("d-none");
      searchBtn.classList.remove("d-none");
    } else {
      badge.innerText = "Inactive";
      badge.className = "badge bg-warning";
      payBtn.classList.remove("d-none");
      searchBtn.classList.add("d-none");
    }

    fetchSentRequests(currentUser.id);
  }

  async function fetchSentRequests(workerId) {
    const container = document.getElementById("sentRequests");

    const { data, error } = await supabaseClient
      .from("jobs")
      .select(`
        id,
        status,
        farmer:profiles!jobs_farmer_id_fkey (
          full_name,
          location
        )
      `)
      .eq("worker_id", workerId)
      .order("created_at", { ascending: false });

    if (error) {
      container.innerHTML = `<p class="text-danger small">${error.message}</p>`;
      return;
    }

    if (!data || data.length === 0) {
      container.innerHTML = `<p class="text-muted small text-center">No requests sent yet.</p>`;
      return;
    }

    container.innerHTML = "";
    data.forEach(job => {
      container.innerHTML += `
        <div class="border rounded p-3 mb-2 bg-white shadow-sm">
          <h6 class="fw-bold text-success">${job.farmer?.full_name}</h6>
          <p class="text-muted small mb-1">${job.farmer?.location || "Location N/A"}</p>
          <span class="badge ${getStatusClass(job.status)}">
            ${job.status.toUpperCase()}
          </span>
        </div>
      `;
    });
  }

  function getStatusClass(status) {
    if (status === "accepted") return "bg-success";
    if (status === "declined") return "bg-danger";
    if (status === "pending") return "bg-warning text-dark";
    return "bg-secondary";
  }

  function handlePayment() {
    const options = {
      key: "rzp_test_S1PAt6cRY4BTfV",
      amount: 2000,
      currency: "INR",
      name: "Kisan Setu",
      description: "Worker Subscription",
      prefill: { email: currentUser.email },
      handler: function () {
        alert("Payment successful! Refreshing profile‚Ä¶");
        setTimeout(() => location.reload(), 2000);
      },
      theme: { color: "#198754" }
    };
    new Razorpay(options).open();
  }

  async function logout() {
    await supabaseClient.auth.signOut();
    location.href = "index.html";
  }

  loadProfile();
</script>

<script>
  supabaseClient.auth.onAuthStateChange((event, session) => {
    if (!session) {
      window.location.replace("index.html");
    }
  });
</script>


</body>
</html>




