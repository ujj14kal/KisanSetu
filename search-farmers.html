<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Search Farmers | Kisan Setu</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <link rel="stylesheet" href="Home.css">
  <link rel="stylesheet" href="auth.css">
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm fixed-top">
  <div class="container">
    <a class="navbar-brand fw-bold text-success" href="index.html">ðŸŒ¾ Kisan Setu</a>
    <button class="btn btn-outline-success" onclick="logout()">Logout</button>
  </div>
</nav>

<section class="auth-section auth-bg">
  <div class="container">
    <div class="auth-card">

      <h4 class="fw-bold text-center mb-3">Search Farmers</h4>

      <div class="input-group mb-4">
        <input type="text" id="locationInput" class="form-control" placeholder="Enter location (e.g. Delhi)">
        <button class="btn btn-success" onclick="searchFarmers()">Search</button>
      </div>

      <div id="subscriptionWarning" class="alert alert-warning text-center d-none shadow-sm">
        <strong>Subscription Inactive:</strong> You need an active subscription to send hiring requests.
        <button class="btn btn-sm btn-success ms-2" onclick="handlePayment()">Pay â‚¹20</button>
      </div>

      <div id="results"></div>

    </div>
  </div>
</section>

<script>
  const { createClient } = supabase;
  const supabaseClient = createClient(
    "https://kyujketzdhkbykybjywu.supabase.co",
    "sb_publishable_L4o-HFt5rMGfY5x_UKPVZw_xNVMf59b"
  );

  let isSubscribed = false;
  let sessionUser = null;

  async function init() {
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (!session) return location.replace("index.html");

    sessionUser = session.user;

    const { data: profile } = await supabaseClient
      .from("profiles")
      .select("role, subscription_active")
      .eq("id", session.user.id)
      .single();

    if (!profile || profile.role !== "worker") {
      location.replace("index.html");
      return;
    }

    isSubscribed = profile.subscription_active;

    document.getElementById("subscriptionWarning")
      .classList.toggle("d-none", isSubscribed);
  }

  async function searchFarmers() {
    const locationStr = document.getElementById("locationInput").value.trim();
    const results = document.getElementById("results");

    if (!locationStr) return;

    results.innerHTML = `
      <div class="text-center my-3">
        <div class="spinner-border text-success"></div>
      </div>`;

    const { data: farmers, error } = await supabaseClient
      .from("profiles")
      .select(`
        id,
        full_name,
        phone,
        location,
        skill,
        crops,
        availability,
        aadhar_verified
      `)
      .eq("role", "farmer")
      .ilike("location", `%${locationStr}%`);

    results.innerHTML = "";

    if (error || !farmers.length) {
      results.innerHTML = `<p class="text-muted text-center">No farmers found.</p>`;
      return;
    }

    farmers.forEach(f => {
      results.innerHTML += `
        <div class="border rounded p-3 mb-3 bg-white shadow-sm text-start">

          <h5 class="fw-bold text-success mb-1">${f.full_name}</h5>
          <p class="text-muted small mb-2">${f.location}</p>

          <div class="row small mb-2">
            <div class="col-6"><strong>Phone:</strong> ${f.phone || "â€”"}</div>
            <div class="col-6">
              <strong>Aadhaar:</strong>
              <span class="badge ${f.aadhar_verified ? 'bg-success' : 'bg-warning'}">
                ${f.aadhar_verified ? 'Verified' : 'Pending'}
              </span>
            </div>
          </div>

          <div class="row small mb-2">
            <div class="col-6"><strong>Skill:</strong> ${f.skill || "â€”"}</div>
            <div class="col-6"><strong>Availability:</strong> ${f.availability || "â€”"}</div>
          </div>

          <div class="small mb-3">
            <strong>Crops:</strong> ${f.crops || "â€”"}
          </div>

          ${
            isSubscribed
            ? `<button class="btn btn-success w-100"
                onclick="hireFarmer('${f.id}', '${f.location || ""}')">
                Send Hiring Request
              </button>`
            : `<button class="btn btn-outline-secondary w-100" disabled>
                Subscribe to Send Request
              </button>`
          }

        </div>`;
    });
  }

  async function hireFarmer(farmerId, farmerLocation) {
    const { error } = await supabaseClient
      .from("jobs")
      .insert([{
        worker_id: sessionUser.id,
        farmer_id: farmerId,
        status: "pending",
        location: farmerLocation || "N/A"
      }]);

    if (error) alert(error.message);
    else {
      alert("Hiring request sent!");
      location.href = "profile-worker.html";
    }
  }

  function handlePayment() {
    const options = {
      key: "rzp_test_S1PAt6cRY4BTfV",
      amount: 2000,
      currency: "INR",
      name: "Kisan Setu",
      description: "Worker Subscription",
      notes: { user_id: sessionUser.id },
      prefill: { email: sessionUser.email },
      handler: () => {
        alert("Payment successful!");
        location.href = "profile-worker.html";
      },
      theme: { color: "#198754" }
    };
    new Razorpay(options).open();
  }

  async function logout() {
    await supabaseClient.auth.signOut();
    location.replace("index.html");
  }

  init();
</script>

</body>
</html>

